name: Create PR 

on:
  workflow_dispatch:

jobs:

  pull-request:
      runs-on: ubuntu-latest
      steps:
      - uses: actions/checkout@v2

      - name: Create psuedo version bump
        run: date +%s > version_bump.txt

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v3
        id: cpr
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: Bump version to X
          body: |
            Version bump
            - Bumping version from Y to X
            - Auto-generated by [create-pull-request][1]
            [1]: https://github.com/peter-evans/create-pull-request

          title: '[Example] Bump Version to X'
          labels: version-bump
          branch: version-bump
          delete-branch: true

      - name: Enable auto-merge for PRs
        env:
          PR_URL: ${{steps.cpr.outputs.pull-request-url}}
          # we'll need to use the service account to create a PAT 
          #  this is because you can't approve a PR from the same GITHUB_TOKEN that created it 
          #  this token should be stored in the environment so that nobody can automerge things into main
          GITHUB_TOKEN: ${{secrets.REPO_TOKEN}}
        run: |
          gh pr review "$PR_URL" --approve
          gh pr merge --merge "$PR_URL"


  # this doesn't work because workflows kicked off by github-actions via GITHUB_TOKEN don't trigger other workflows. Using another PAT is possible 
  # but it doesn't solve the auto merge problem and the label conditional doesn't appear to work 
  #     - uses: hmarr/auto-approve-action@v2.0.0
  # #       if: github.actor == 'github-actions[bot]' && github.event.label.name == 'version-bump'
  #       if: github.actor == 'github-actions[bot]'
  #       with:
  #         github-token: "${{ secrets.GITHUB_TOKEN }}"


